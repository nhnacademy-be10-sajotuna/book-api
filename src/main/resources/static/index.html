<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>책 목록</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
    .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    h1, h2 { color: #333; }
    button {
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover { background-color: #0056b3; }
    #bookList, #categoryListTable {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
    }
    #bookList th, #bookList td,
    #categoryListTable th, #categoryListTable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #bookList th, #categoryListTable th {
      background-color: #f2f2f2;
    }
    /* 책 제목 링크 스타일 */
    #bookList td a {
      color: #007bff;
      text-decoration: none;
      font-weight: bold;
    }
    #bookList td a:hover {
      text-decoration: underline;
    }
    /* 카테고리 표시를 위한 스타일 (트리 구조) */
    .category-tree ul {
      list-style: none;
      padding-left: 20px;
    }
    .category-tree li {
      margin-bottom: 5px;
    }
    .category-tree li span {
      font-weight: bold;
    }
    .category-tree li.level-0 > span {
      color: #0056b3;
    }
    .category-tree li.level-1 > span {
      color: #28a745;
    }
    .category-tree li.level-2 > span {
      color: #ffc107;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>책 정보 관리</h1>
  <p>이 페이지는 Spring Boot 백엔드에서 제공하는 API를 사용하여 데이터를 표시합니다.</p>

  <h2>책 목록</h2>
  <button onclick="loadBooks()">책 목록 가져오기</button>
  <table id="bookList">
    <thead>
    <tr>
      <th>ISBN</th>
      <th>제목</th>
      <th>저자</th>
      <th>가격</th>
      <th>할인율</th>
      <th>카테고리</th>
      <th>좋아요</th>
    </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <hr>

  <h2>카테고리 목록 (트리 구조)</h2>
  <button onclick="loadCategories()">카테고리 목록 가져오기</button>
  <div id="categoryListContainer">
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    loadBooks();
    loadCategories();
  });

  async function loadBooks() {
    try {
      const response = await fetch('http://localhost:8080/api/books');
      const books = await response.json();
      const bookListBody = document.querySelector('#bookList tbody');
      bookListBody.innerHTML = '';

      if (books.length === 0) {
        bookListBody.innerHTML = '<tr><td colspan="7">등록된 책이 없습니다.</td></tr>';
        return;
      }

      books.forEach(book => {
        const row = bookListBody.insertRow();
        row.insertCell().textContent = book.isbn;
        const titleCell = row.insertCell();
        // 책 제목을 클릭 가능한 링크로 변경
        const titleLink = document.createElement('a');
        titleLink.href = `/book-detail.html?isbn=${book.isbn}`; // 새로운 상세 페이지 URL
        titleLink.textContent = book.title;
        titleCell.appendChild(titleLink);

        row.insertCell().textContent = book.author;
        row.insertCell().textContent = book.sellingPrice.toLocaleString('ko-KR') + '원';
        row.insertCell().textContent = book.discountRate ? book.discountRate.toFixed(2) + '%' : '0.00%';
        const categoryNames = book.categories ? book.categories.map(cat => cat.name).join(', ') : '없음';
        row.insertCell().textContent = categoryNames;
        row.insertCell().textContent = book.likes;
      });
    } catch (error) {
      console.error('책 목록을 가져오는 중 오류 발생:', error);
      alert('책 목록을 가져오지 못했습니다. 서버가 실행 중인지 확인하세요.');
    }
  }

  async function loadCategories() {
    try {
      const response = await fetch('http://localhost:8080/api/books/categories');
      const categories = await response.json();
      const categoryListContainer = document.getElementById('categoryListContainer');
      categoryListContainer.innerHTML = '';

      if (categories.length === 0) {
        categoryListContainer.innerHTML = '<p>등록된 카테고리가 없습니다.</p>';
        return;
      }

      const topLevelCategories = categories.filter(cat => !cat.parentCategoryName);

      function renderCategoryTree(category, level = 0) {
        let html = `<li class="level-${level}">`;
        html += `<span>ID: ${category.id} | ${category.name}`;
        if (category.parentCategoryName) {
          html += ` (상위: ${category.parentCategoryName})`;
        }
        html += `</span>`;

        if (category.subCategories && category.subCategories.length > 0) {
          html += `<ul>`;
          category.subCategories.forEach(subCategory => {
            html += renderCategoryTree(subCategory, level + 1);
          });
          html += `</ul>`;
        }
        html += `</li>`;
        return html;
      }

      let fullHtml = '<div class="category-tree"><ul>';
      topLevelCategories.forEach(cat => {
        fullHtml += renderCategoryTree(cat, 0);
      });
      fullHtml += '</ul></div>';

      categoryListContainer.innerHTML = fullHtml;

    } catch (error) {
      console.error('카테고리 목록을 가져오는 중 오류 발생:', error);
      alert('카테고리 목록을 가져오지 못했습니다. 서버가 실행 중인지 확인하세요.');
    }
  }
</script>
</body>
</html>